name: Tea Guestbook Auto-Reply

on:
  issues:
    types: [opened]

permissions:
  issues: write

concurrency:
  group: tea-guestbook-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Reply + title + close + lock (Tea Guestbook)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = issue.body || "";
            const user = issue.user?.login || "friend";
            const title = issue.title || "";

            // Detect Tea issues robustly (no label timing dependency)
            const titleLooksLikeTea =
              /^\s*☕/u.test(title) ||
              /\btea guestbook\b/i.test(title) ||
              /\bcup of tea\b/i.test(title);

            // Also allow detection by structure: at least two headings in issue-form style
            const headingCount = (body.match(/(?:^|\r?\n)###\s+/g) || []).length;
            const isTeaGuestbook = titleLooksLikeTea || headingCount >= 2;

            if (!isTeaGuestbook) {
              core.info("Not a Tea Guestbook issue. Exiting.");
              return;
            }

            // Avoid double-commenting
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const alreadyReplied = comments.some(c =>
              (c.user?.type === "Bot" || /\[bot\]/i.test(c.user?.login || "")) &&
              /\bYour tea is ready\b|\bcup of tea to-go\b/i.test(c.body || "")
            );

            // ---- Position-based parsing (robust to heading text changes) ----
            // Parse "### Heading\n\nAnswer" pairs regardless of heading text.
            const pairs = [];
            const re = /(?:^|\r?\n)###\s+[^\r\n]+\r?\n\r?\n([^\r\n]+)\r?\n?/g;
            let m;
            while ((m = re.exec(body)) !== null) {
              pairs.push(m[1].trim());
            }

            const tea = pairs[0] || "";
            const mood = pairs[1] || "";

            const teaText = tea ? `Your **${tea}** is ready.` : `Your tea is ready.`;

            let msg;
            switch ((mood || "").toLowerCase()) {
              case "great":
                msg = `☕ Hey @${user} — love that for you. ${teaText}`;
                break;
              case "good":
                msg = `☕ Hey @${user} — glad to hear it. ${teaText}`;
                break;
              case "meh":
                msg = `☕ Hey @${user} — “meh”
