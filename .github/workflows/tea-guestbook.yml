name: Tea Guestbook

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  tea:
    runs-on: ubuntu-latest
    steps:
      - name: Detect Tea Guestbook issue (stable marker)
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const isTea = /<!--\s*TEA_GUESTBOOK\s*-->/i.test(body);
            core.setOutput("is_tea", isTea ? "true" : "false");
            if (!isTea) core.info("Not a Tea Guestbook issue. Skipping.");

      - uses: actions/checkout@v4
        if: steps.gate.outputs.is_tea == 'true'

      - uses: actions/setup-python@v5
        if: steps.gate.outputs.is_tea == 'true'
        with:
          python-version: "3.11"

      - name: Log mug + update badges + render wall
        if: steps.gate.outputs.is_tea == 'true'
        continue-on-error: true
        run: |
          python scripts/tea_add_from_issue.py
          python scripts/tea_update_badges.py
          python scripts/tea_render_wall.py

      - name: Commit updates
        if: steps.gate.outputs.is_tea == 'true'
        continue-on-error: true
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -A
          git commit -m "chore: serve tea" || exit 0
          git push

      # IMPORTANT: this runs even if previous steps failed
      - name: Comment + close + lock (mood-based)
        if: always() && steps.gate.outputs.is_tea == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            const user = issue.user?.login || "friend";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            function extractAny(labels) {
              for (const label of labels) {
                const re = new RegExp(`###\\s+${label}\\s*\\n\\n([^\\n]+)`, "i");
                const m = body.match(re);
                if (m) return m[1].trim();
              }
              return "";
            }

            const tea = extractAny([
              "Which flavor of tea would you like\\?",
              "What flavor tea would you like\\?"
            ]);

            const mood = extractAny(["How are you\\?"]);

            const newTitle = `â˜• A cup of tea to-go for @${user}`;
            const teaText = tea ? `Your **${tea}** is ready` : `Your tea is ready`;

            let msg;
            switch ((mood || "").toLowerCase()) {
              case "great":
                msg = `â˜• Hey @${user} â€” love that for you ğŸ«¶ğŸ½ ${teaText}.`;
                break;
              case "good":
                msg = `â˜• Hey @${user} â€” glad to hear it ğŸ™‚ ${teaText}.`;
                break;
              case "meh":
                msg = `â˜• Hey @${user} â€” â€œmehâ€ days count too. ${teaText}. Hope it softens a bit ğŸ¤`;
                break;
              case "not so great":
                msg = `â˜• Hey @${user} â€” sorry itâ€™s heavy ğŸ«¶ğŸ½. ${teaText}. One gentle win today is enough ğŸ¤`;
                break;
              default:
                msg = `â˜• Hey @${user} â€” ${teaText}.`;
            }

            await github.rest.issues.update({ owner, repo, issue_number, title: newTitle });
            await github.rest.issues.createComment({ owner, repo, issue_number, body: msg });
            await github.rest.issues.update({ owner, repo, issue_number, state: "closed" });

            try {
              await github.rest.issues.lock({ owner, repo, issue_number, lock_reason: "resolved" });
            } catch (e) {
              core.warning(`Lock failed: ${e.message}`);
            }
