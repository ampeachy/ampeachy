name: Tea Guestbook

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

jobs:
  tea:
    if: contains(github.event.issue.labels.*.name, 'tea-mug')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Log mug + update badges + render wall
        run: |
          python scripts/tea_add_from_issue.py
          python scripts/tea_update_badges.py
          python scripts/tea_render_wall.py

      - name: Commit updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/tea_guestbook.json data/badge_tea_total.json data/badge_tea_today.json assets/tea-wall.svg
          git commit -m "chore: serve tea" || exit 0
          git push

      - name: Comment + close + lock (mood-based)
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            const user = issue.user?.login || "friend";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            function extract(label) {
              const re = new RegExp(`###\\s+${label}\\s*\\n\\n([^\\n]+)`, "i");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            // Match your current issue form text:
            const tea =
              extract("What flavor tea would you like\\?") ||
              extract("What flavor of tea would you like\\?") ||
              "";

            const mood = extract("How are you\\?") || "";

            const newTitle = `â˜• A cup of tea to-go for @${user}`;
            const teaText = tea ? `Your **${tea}** is ready` : `Your tea is ready`;

            let msg;
            switch (mood.toLowerCase()) {
              case "great":
                msg = `â˜• Hey @${user} â€” love that for you ğŸ«¶ğŸ½ ${teaText}. Thanks for stopping by âœ¨`;
                break;
              case "good":
                msg = `â˜• Hey @${user} â€” glad to hear it ğŸ˜Š ${teaText}. Thanks for stopping by ğŸŒ¿`;
                break;
              case "meh":
                msg = `â˜• Hey @${user} â€” â€œmehâ€ days count too. ${teaText}. Hope your day softens a little ğŸ¤`;
                break;
              case "not so great":
                msg = `â˜• Hey @${user} â€” sorry itâ€™s heavy right now ğŸ«¶ğŸ½. ${teaText}. One gentle win today is enough ğŸ¤`;
                break;
              default:
                msg = `â˜• Hey @${user} â€” ${teaText}. Thanks for stopping by ğŸŒ¿`;
            }

            await github.rest.issues.update({ owner, repo, issue_number, title: newTitle });
            await github.rest.issues.createComment({ owner, repo, issue_number, body: msg });
            await github.rest.issues.update({ owner, repo, issue_number, state: "closed" });

            // Try to lock, but don't fail the run if locking errors.
            try {
              await github.rest.issues.lock({ owner, repo, issue_number, lock_reason: "resolved" });
            } catch (e) {
              console.log(`Lock failed: ${e.message}`);
            }
