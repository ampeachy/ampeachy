name: Tea Guestbook Auto-Reply

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Reply + close + lock (Tea Guestbook)
        uses: actions/github-script@v7
        with:
          script: |
            const core = require("@actions/core");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Always fetch the live issue (more reliable than the event payload)
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = issue.body || "";
            const user = issue.user?.login || "friend";

            // Only respond to your tea form (marker-based, not wording-based)
            if (!body.includes("<!-- tea-guestbook -->")) {
              core.info("Not a Tea Guestbook issue. Exiting.");
              return;
            }

            // Extract answers (flexible: does not depend on exact question text)
            function extractAnswer(questionRegex) {
              const re = new RegExp(`###\\s+${questionRegex}\\s*\\n\\n([^\\n]+)`, "i");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            const tea = extractAnswer(".*flavor.*tea.*\\?") || "";
            const mood = extractAnswer("How are you\\?") || "";

            const teaText = tea ? `Your **${tea}** is ready.` : `Your tea is ready.`;

            let msg;
            switch ((mood || "").toLowerCase()) {
              case "great":
                msg = `â˜• Hey @${user} â€” love that for you ğŸ«¶ğŸ½ ${teaText}`;
                break;
              case "good":
                msg = `â˜• Hey @${user} â€” glad to hear it ğŸ™‚ ${teaText}`;
                break;
              case "meh":
                msg = `â˜• Hey @${user} â€” â€œmehâ€ days count too. ${teaText} Hope it softens a bit ğŸ¤`;
                break;
              case "not so great":
                msg = `â˜• Hey @${user} â€” sorry itâ€™s heavy ğŸ«¶ğŸ½. ${teaText} One gentle win today is enough ğŸ¤`;
                break;
              default:
                msg = `â˜• Hey @${user} â€” ${teaText}`;
            }

            // Comment
            await github.rest.issues.createComment({ owner, repo, issue_number, body: msg });

            // Close
            await github.rest.issues.update({ owner, repo, issue_number, state: "closed" });

            // Lock (don't fail if lock isn't allowed)
            try {
              await github.rest.issues.lock({ owner, repo, issue_number, lock_reason: "resolved" });
            } catch (e) {
              core.warning(`Lock failed: ${e.message}`);
            }
