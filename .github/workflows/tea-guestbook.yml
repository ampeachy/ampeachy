name: Tea Guestbook Auto-Reply

on:
  issues:
    types: [opened]

permissions:
  issues: write

concurrency:
  group: tea-guestbook-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Reply + title + close + lock (Tea Guestbook)
        uses: actions/github-script@v7
        with:
          script: |
            const core = require("@actions/core");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Fetch live issue (more reliable than event payload)
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = issue.body || "";
            const user = issue.user?.login || "friend";
            const title = issue.title || "";

            // ---- Robust Tea detection (NO label timing dependency) ----
            // Prefer title-based detection (most stable); marker/body checks are secondary.
            const titleLooksLikeTea =
              /^\s*☕/u.test(title) ||
              /\btea guestbook\b/i.test(title) ||
              /\bcup of tea\b/i.test(title);

            const hasMarker = body.includes("tea-guestbook"); // avoid HTML comment reliance

            // Body structure fallback: tolerate wording variants
            const hasTeaFlavorQ = /###\s+.*(flavor|tea).*?\?\s*\n\s*\n/i.test(body);
            const hasMoodQ = /###\s+.*(how\s+are\s+you|mood).*?\?\s*\n\s*\n/i.test(body);

            const isTeaGuestbook = titleLooksLikeTea || hasMarker || (hasTeaFlavorQ && hasMoodQ);

            if (!isTeaGuestbook) {
              core.info("Not a Tea Guestbook issue. Exiting.");
              return;
            }

            // ---- Idempotency guard (avoid double-commenting) ----
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const alreadyReplied = comments.some(c =>
              (c.user?.type === "Bot" || /\[bot\]/i.test(c.user?.login || "")) &&
              /your tea is ready|cup of tea to-go/i.test(c.body || "")
            );

            // ---- Extract answers (flexible, wording-variant friendly) ----
            function extractAnswer(questionRegex) {
              const re = new RegExp(`###\\s+${questionRegex}\\s*\\n\\n([^\\n]+)`, "i");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            const tea = extractAnswer(".*(flavor|tea).*\\?") || "";
            const mood = extractAnswer(".*(how\\s+are\\s+you|mood).*\\?") || "";

            const teaText = tea ? `Your **${tea}** is ready.` : `Your tea is ready.`;

            let msg;
            switch ((mood || "").toLowerCase()) {
              case "great":
                msg = `☕ Hey @${user} — love that for you. ${teaText}`;
                break;
              case "good":
                msg = `☕ Hey @${user} — glad to hear it. ${teaText}`;
                break;
              case "meh":
                msg = `☕ Hey @${user} — “meh” days count too. ${teaText} Hope it softens a bit.`;
                break;
              case "not so great":
                msg = `☕ Hey @${user} — sorry it’s heavy. ${teaText} One gentle win today is enough.`;
                break;
              default:
                msg = `☕ Hey @${user} — ${teaText}`;
            }

            // ---- PRIMARY GOAL: Comment FIRST (with explicit error logging) ----
            if (!alreadyReplied) {
              try {
                await github.rest.issues.createComment({ owner, repo, issue_number, body: msg });
                core.info("Posted Tea Guestbook comment.");
              } catch (e) {
                core.error(`createComment failed: status=${e.status || "unknown"} message=${e.message}`);
                core.error(
                  "Most common fix: Repo Settings → Actions → General → Workflow permissions → Read and write permissions."
                );
                throw e; // fail loudly so it can't "silently" not comment
              }
            } else {
              core.info("Bot already replied; skipping duplicate comment.");
            }

            // ---- Title update (best effort) ----
            const desiredTitle = `☕ A cup of tea to-go for @${user}`;
            if (title !== desiredTitle) {
              try {
                await github.rest.issues.update({ owner, repo, issue_number, title: desiredTitle });
                core.info("Updated issue title.");
              } catch (e) {
                core.warning(`Title update failed: status=${e.status || "unknown"} message=${e.message}`);
              }
            }

            // ---- Close (best effort but should almost always work) ----
            if (issue.state !== "closed") {
              try {
                await github.rest.issues.update({ owner, repo, issue_number, state: "closed" });
                core.info("Closed issue.");
              } catch (e) {
                core.warning(`Close failed: status=${e.status || "unknown"} message=${e.message}`);
              }
            }

            // ---- Lock (NEVER fail workflow) ----
            try {
              await github.rest.issues.lock({ owner, repo, issue_number, lock_reason: "resolved" });
              core.info("Locked issue.");
            } catch (e) {
              core.warning(`Lock failed (ignored): status=${e.status || "unknown"} message=${e.message}`);
            }
