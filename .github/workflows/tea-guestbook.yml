name: Tea Guestbook

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  tea:
    runs-on: ubuntu-latest

    steps:
      # 1) DEBUG: show what GitHub sees (this is the "flashlight" ğŸ”¦)
      - name: Debug issue info
        run: |
          echo "TITLE: ${{ github.event.issue.title }}"
          echo "LABELS: ${{ toJson(github.event.issue.labels.*.name) }}"

      # Weâ€™ll reuse this same â€œis this tea?â€ rule on each step:
      # If label tea-mug exists OR title starts with your template title
      - uses: actions/checkout@v4
        if: |
          contains(github.event.issue.labels.*.name, 'tea-mug') ||
          startsWith(github.event.issue.title, 'â˜• A cup of tea to-go')

      - uses: actions/setup-python@v5
        if: |
          contains(github.event.issue.labels.*.name, 'tea-mug') ||
          startsWith(github.event.issue.title, 'â˜• A cup of tea to-go')
        with:
          python-version: "3.11"

      - name: Log mug + update badges
        if: |
          contains(github.event.issue.labels.*.name, 'tea-mug') ||
          startsWith(github.event.issue.title, 'â˜• A cup of tea to-go')
        run: |
          python scripts/tea_add_from_issue.py
          python scripts/tea_update_badges.py

      - name: Commit updates
        if: |
          contains(github.event.issue.labels.*.name, 'tea-mug') ||
          startsWith(github.event.issue.title, 'â˜• A cup of tea to-go')
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/tea_guestbook.json data/badge_tea_total.json data/badge_tea_today.json
          git commit -m "chore: serve tea" || exit 0
          git push

      - name: Comment + close + lock (mood-based)
        if: |
          contains(github.event.issue.labels.*.name, 'tea-mug') ||
          startsWith(github.event.issue.title, 'â˜• A cup of tea to-go')
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            const user = issue.user?.login || "friend";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            function extract(heading) {
              const re = new RegExp(`###\\s+${heading}\\s*\\n\\n([^\\n]+)`, "i");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            // These MUST match your issue form labels exactly:
            const tea = extract("What flavor tea would you like\\?") || "";
            const mood = extract("How are you\\?") || "";

            const newTitle = `â˜• Tea to-go for @${user}`;
            const teaText = tea ? `Your **${tea}** is ready` : `Your tea is ready`;

            let msg;
            switch (mood.toLowerCase()) {
              case "great":
                msg = `â˜• Hey @${user} â€” love that for you ğŸ«¶ğŸ½ ${teaText}. Thanks for stopping by âœ¨`;
                break;
              case "good":
                msg = `â˜• Hey @${user} â€” glad to hear it ğŸ™‚ ${teaText}. Thanks for stopping by ğŸŒ¿`;
                break;
              case "meh":
                msg = `â˜• Hey @${user} â€” â€œmehâ€ days count too. ${teaText}. Hope your day softens a little ğŸ¤`;
                break;
              case "not so great":
                msg = `â˜• Hey @${user} â€” sorry itâ€™s heavy right now ğŸ«¶ğŸ½. ${teaText}. One gentle win today is enough ğŸ¤`;
                break;
              default:
                msg = `â˜• Hey @${user} â€” ${teaText}. Thanks for stopping by ğŸŒ¿`;
            }

            await github.rest.issues.update({ owner, repo, issue_number, title: newTitle });
            await github.rest.issues.createComment({ owner, repo, issue_number, body: msg });
            await github.rest.issues.update({ owner, repo, issue_number, state: "closed" });

            try {
              await github.rest.issues.lock({ owner, repo, issue_number, lock_reason: "resolved" });
            } catch (e) {
              console.log(`Lock failed (ignored): ${e.message}`);
            }
